name: Track SQL Server Database Changes

on:
  schedule:
    - cron: "0 * * * *"  # Runs every hour (adjust as needed)
  workflow_dispatch:  # Allows manual trigger

jobs:
  export-database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Microsoft SQL Server Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg2
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
          curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
          source ~/.bashrc

      - name: Verify Installation
        run: sqlcmd -?

      - name: Export Database Schema (php_ecom)
        run: |
          sqlcmd -S ${{ secrets.DB_HOST }},${{ secrets.DB_PORT }} \
                 -U ${{ secrets.DB_USER }} \
                 -P ${{ secrets.DB_PASS }} \
                 -d php_ecom \
                 -Q "EXEC sp_help" > database/schema.sql

      - name: Export Database Data (php_ecom)
        run: |
          sqlcmd -S ${{ secrets.DB_HOST }},${{ secrets.DB_PORT }} \
                 -U ${{ secrets.DB_USER }} \
                 -P ${{ secrets.DB_PASS }} \
                 -d php_ecom \
                 -Q "SET NOCOUNT ON; EXEC sp_MSforeachtable 'SELECT * FROM ?'" > database/data.sql

      - name: Check for Changes and Commit
        run: |
          git add database/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Updated php_ecom database schema & data" && git push)
