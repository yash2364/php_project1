name: Database Backup & Restore

on:
  schedule:
    - cron: '0 */3 * * *'  # Runs every 3 hours
  workflow_dispatch:  # Allows manual execution

jobs:
  backup_restore:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Executable Permissions
        run: chmod +x backups/backup_db.sh backups/restore_db.sh

      - name: Verify MySQL Process by PID (4324)
        run: |
          PID_FOUND=$(ps -aux | grep "mysqld" | awk '{print $2}' | grep -w 4324)
          if [ -z "$PID_FOUND" ]; then
            echo "‚ùå MySQL process with PID 4324 not found!"
            exit 1
          else
            echo "‚úÖ MySQL is running with PID 4324"
          fi

      - name: Check MySQL Status
        env:
          MYSQL_HOST: "192.168.29.245"
          MYSQL_PORT: "3306"
          MYSQL_USER: "ci_user"
          MYSQL_PASSWORD: "${{ secrets.MYSQL_PASSWORD }}"
        run: |
          nc -zv $MYSQL_HOST $MYSQL_PORT || { echo "‚ùå MySQL Port Unreachable!"; exit 1; }
          mysqladmin ping -h $MYSQL_HOST -P $MYSQL_PORT -u $MYSQL_USER --password="$MYSQL_PASSWORD" || exit 1

      - name: Run Backup Script
        env:
          MYSQL_USER: "ci_user"
          MYSQL_PASSWORD: "${{ secrets.MYSQL_PASSWORD }}"
          MYSQL_HOST: "192.168.29.245"
          MYSQL_PORT: "3306"
          MYSQL_DB: "php_ecom"
        run: bash backups/backup_db.sh

      - name: Commit and Push Backup
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add backups/
          git commit -m "üîÑ Database backup: $(date)"
          git push

      - name: Run Restore Script (Optional)
        if: github.event_name == 'workflow_dispatch'
        env:
          MYSQL_USER: "ci_user"
          MYSQL_PASSWORD: "${{ secrets.MYSQL_PASSWORD }}"
          MYSQL_HOST: "192.168.29.245"
          MYSQL_PORT: "3306"
          MYSQL_DB: "php_ecom"
        run: bash backups/restore_db.sh
